<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Articles | IR Notes Hub</title>

<link rel="icon" href="/assests/img/icon.png">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Poppins,sans-serif;
  background:#050505;
  color:#e0e0e0;
}
header{
  background:#000;
  border-bottom:1px solid #1a1a1a;
  padding:18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header a{
  color:#ffeb3b;
  font-weight:800;
  text-decoration:none;
}
.account-panel{
  display:flex;
  gap:10px;
  align-items:center;
  border:1px solid #2a2a2a;
  padding:8px 10px;
  border-radius:999px;
  position:relative;
}
.account-dot{
  width:34px;
  height:34px;
  border-radius:50%;
  border:1px solid #2a2a2a;
  background:none;
  color:#ffeb3b;
  cursor:pointer;
  font-size:18px;
  font-weight:900;
}
.account-meta{line-height:1.1}
.account-meta .label{font-weight:900;font-size:.82rem}
.account-meta .sub{font-size:.72rem;color:#999}
.account-menu{
  position:absolute;
  right:0;
  top:calc(100% + 10px);
  width:260px;
  background:#0a0a0a;
  border:1px solid #2a2a2a;
  border-radius:14px;
  padding:10px;
  display:none;
  z-index:999;
}
.account-menu a,.account-menu button{
  width:100%;
  padding:10px;
  border-radius:10px;
  background:none;
  border:0;
  color:#ffeb3b;
  font-weight:900;
  cursor:pointer;
  display:flex;
  gap:10px;
  align-items:center;
  text-decoration:none;
}
.account-menu a:hover,.account-menu button:hover{
  background:rgba(0,114,255,.2);
  color:#00e5ff;
}
main{
  max-width:1100px;
  margin:auto;
  padding:28px 18px 60px;
}
.grid{
  display:grid;
  grid-template-columns:1fr;
  gap:16px;
}
@media(min-width:768px){.grid{grid-template-columns:repeat(2,1fr)}}
.card{
  background:#161616;
  border:1px solid #333;
  border-radius:16px;
  padding:18px;
}
.card h3{margin:0 0 6px}
.meta{color:#777;font-size:.85rem;margin-bottom:8px}
.actions button{
  margin-top:10px;
  border-radius:999px;
  padding:10px 14px;
  border:1px solid #2a2a2a;
  background:none;
  color:#ffeb3b;
  font-weight:900;
  cursor:pointer;
}
.actions button:hover{
  color:#00e5ff;
  border-color:#0072ff;
}
#msg{color:#888}
</style>

<script src="/assests/js/env.js"></script>
<script type="module" src="/assests/js/supabase-client.js"></script>
</head>

<body>

<header>
  <a href="/">IR Notes Hub</a>

  <div class="account-panel" id="accountPanel">
    <button class="account-dot" id="accountBtn">⋮</button>
    <div class="account-meta">
      <div class="label" id="accountLabel">Guest</div>
      <div class="sub" id="accountSub">Not logged in</div>
    </div>

    <div class="account-menu" id="accountMenu">
      <a id="loginBtn" href="/login.html"><i class="fa-solid fa-right-to-bracket"></i> Login</a>
      <a id="signupBtn" href="/signup.html"><i class="fa-solid fa-user-plus"></i> Sign up</a>
      <a id="submitBtn" href="/upload.html" style="display:none"><i class="fa-solid fa-cloud-arrow-up"></i> Submit PDF</a>
      <button id="logoutBtn" style="display:none"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
    </div>
  </div>
</header>

<main>
  <h1>Articles</h1>
  <p class="meta">Browse approved notes. Login required to read.</p>
  <p id="msg">Loading…</p>
  <div class="grid" id="list"></div>
</main>

<script type="module">
async function waitForSupabase(){
  for(let i=0;i<120;i++){
    if(window.supabase?.auth) return window.supabase;
    await new Promise(r=>setTimeout(r,50));
  }
  throw new Error("Supabase not loaded");
}

const supabase = await waitForSupabase();

/* Account menu toggle */
const panel=document.getElementById("accountPanel");
const menu=document.getElementById("accountMenu");
document.getElementById("accountBtn").onclick=e=>{
  e.stopPropagation();
  menu.style.display=menu.style.display==="block"?"none":"block";
};
document.addEventListener("click",e=>{
  if(!panel.contains(e.target)) menu.style.display="none";
});

/* Auth UI */
const label=document.getElementById("accountLabel");
const sub=document.getElementById("accountSub");
const loginBtn=document.getElementById("loginBtn");
const signupBtn=document.getElementById("signupBtn");
const submitBtn=document.getElementById("submitBtn");
const logoutBtn=document.getElementById("logoutBtn");

async function refreshAuth(){
  const {data}=await supabase.auth.getSession();
  const s=data.session;

  if(!s){
    label.textContent="Guest";
    sub.textContent="Not logged in";
    loginBtn.style.display="";
    signupBtn.style.display="";
    submitBtn.style.display="none";
    logoutBtn.style.display="none";
    return null;
  }

  label.textContent=s.user.email;
  sub.textContent="Logged in";
  loginBtn.style.display="none";
  signupBtn.style.display="none";
  submitBtn.style.display="";
  logoutBtn.style.display="";
  return s;
}

logoutBtn.onclick = async () => {
  label.textContent = "Guest";
  sub.textContent = "Not logged in";

  loginBtn.style.display = "";
  signupBtn.style.display = "";
  submitBtn.style.display = "none";
  logoutBtn.style.display = "none";

  await supabase.auth.signOut();
};


let session=await refreshAuth();
supabase.auth.onAuthStateChange(refreshAuth);

/* Load articles (NO LOGIN REQUIRED) */
const msg=document.getElementById("msg");
const list=document.getElementById("list");

const {data,error}=await supabase
  .from("submissions")
  .select("title,description,topic,file_path")
  .eq("status","approved")
  .order("created_at",{ascending:false});

if(error){
  msg.textContent="Failed to load articles.";
  console.error(error);
}else if(!data.length){
  msg.textContent="No articles found.";
}else{
  msg.textContent="";
  for(const r of data){
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <h3>${r.title}</h3>
      <div class="meta">${r.topic||""}</div>
      <p>${r.description||""}</p>
      <div class="actions">
        <button><i class="fa-regular fa-file-pdf"></i> Read</button>
      </div>`;
    card.querySelector("button").onclick=async()=>{
      if(!session){
        location.href="/login.html?next=/articles/";
        return;
      }
      const {data}=await supabase.storage
        .from("pdfs")
        .createSignedUrl(r.file_path,600);
      window.open(data.signedUrl,"_blank");
    };
    list.appendChild(card);
  }
}
</script>
</body>
</html>
