<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Articles | IR Notes Hub</title>

  <link rel="icon" href="/assests/img/icon.png" type="image/png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    * { box-sizing: border-box; }
    body { margin:0; font-family:'Poppins',sans-serif; background:#050505; color:#e0e0e0; }

    header {
      background:#000;
      border-bottom:1px solid #1a1a1a;
      padding:18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    header a { color:#ffeb3b; text-decoration:none; font-weight:800; }
    header a:hover { color:#00e5ff; }

    .account-panel {
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid #2a2a2a;
      background:rgba(255,255,255,0.03);
      position:relative;
    }

    .account-dot {
      width:34px;
      height:34px;
      border-radius:999px;
      border:1px solid #2a2a2a;
      color:#ffeb3b;
      background:transparent;
      cursor:pointer;
      font-size:18px;
      font-weight:900;
    }

    .account-menu {
      position:absolute;
      right:0;
      top:calc(100% + 10px);
      width:280px;
      background:#0b0b0b;
      border:1px solid #2a2a2a;
      border-radius:16px;
      padding:10px;
      display:none;
      z-index:9999;
    }

    .account-menu a,
    .account-menu button {
      width:100%;
      padding:10px;
      border-radius:12px;
      background:transparent;
      border:0;
      color:#ffeb3b;
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      display:block;
    }

    .danger { color:#ff4b2b; }

    main {
      max-width:1100px;
      margin:0 auto;
      padding:28px 18px 60px;
    }

    .grid {
      display:grid;
      grid-template-columns:1fr;
      gap:16px;
    }

    @media (min-width:768px) {
      .grid { grid-template-columns:repeat(2,1fr); }
    }

    .card {
      background:#161616;
      border:1px solid #333;
      border-radius:16px;
      padding:18px;
    }

    button {
      border-radius:999px;
      padding:10px 14px;
      border:1px solid #2a2a2a;
      background:transparent;
      color:#ffeb3b;
      font-weight:800;
      cursor:pointer;
    }
  </style>

  <!-- existing supabase setup -->
  <script src="/assests/js/env.js"></script>
</head>

<body>

<header>
  <a href="/">← Home</a>

  <div class="account-panel">
    <button class="account-dot" id="accountBtn">⋮</button>
    <div>
      <div id="accountLabel">Guest</div>
      <div id="accountSub">Not logged in</div>
    </div>

    <div class="account-menu" id="accountMenu">
      <a id="menuLogin" href="/login.html">Login</a>
      <a id="menuSignup" href="/signup.html">Sign up</a>
      <a id="menuSubmit" href="/upload.html" style="display:none;">Submit PDF</a>
      <a id="menuMySub" href="/my-submissions.html" style="display:none;">My submissions</a>
      <button id="menuLogout" class="danger" style="display:none;">Logout</button>
    </div>
  </div>
</header>

<main>
  <h1>Articles</h1>
  <p id="msg">Loading…</p>
  <div id="list" class="grid"></div>
</main>

<script>
  const supabase = window.supabase;

  const msg = document.getElementById("msg");
  const list = document.getElementById("list");

  const accountBtn = document.getElementById("accountBtn");
  const accountMenu = document.getElementById("accountMenu");
  const accountLabel = document.getElementById("accountLabel");
  const accountSub = document.getElementById("accountSub");

  const menuLogin = document.getElementById("menuLogin");
  const menuSignup = document.getElementById("menuSignup");
  const menuSubmit = document.getElementById("menuSubmit");
  const menuMySub = document.getElementById("menuMySub");
  const menuLogout = document.getElementById("menuLogout");

  let currentSession = null;

  accountBtn.onclick = () => {
    accountMenu.style.display =
      accountMenu.style.display === "block" ? "none" : "block";
  };

  function syncAccount(session) {
    currentSession = session;

    if (!session) {
      accountLabel.textContent = "Guest";
      accountSub.textContent = "Not logged in";
      menuLogin.style.display = "";
      menuSignup.style.display = "";
      menuSubmit.style.display = "none";
      menuMySub.style.display = "none";
      menuLogout.style.display = "none";
      return;
    }

    accountLabel.textContent = session.user.email;
    accountSub.textContent = "Logged in";
    menuLogin.style.display = "none";
    menuSignup.style.display = "none";
    menuSubmit.style.display = "";
    menuMySub.style.display = "";
    menuLogout.style.display = "";
  }

  menuLogout.onclick = async () => {
    await supabase.auth.signOut();
    location.reload();
  };

  async function openPdf(path) {
    if (!currentSession) {
      alert("Please login to read this article.");
      location.href = "/login.html";
      return;
    }

    const { data } = await supabase
      .storage
      .from("pdfs")
      .createSignedUrl(path, 600);

    if (data?.signedUrl) {
      window.open(data.signedUrl, "_blank", "noopener");
    }
  }

  async function loadArticles() {
    msg.textContent = "Loading…";

    const { data, error } = await supabase
      .from("submissions")
      .select("title,description,file_path")
      .eq("status", "approved")
      .order("created_at", { ascending: false });

    if (error || !data || data.length === 0) {
      msg.textContent = "No approved articles available.";
      return;
    }

    msg.textContent = "";
    list.innerHTML = "";

    data.forEach(row => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <h3>${row.title}</h3>
        <p>${row.description || ""}</p>
        <button>Open PDF</button>
      `;
      card.querySelector("button").onclick = () => openPdf(row.file_path);
      list.appendChild(card);
    });
  }

  // initial load
  supabase.auth.getSession().then(({ data }) => {
    syncAccount(data.session);
    loadArticles();
  });

  supabase.auth.onAuthStateChange((_event, session) => {
    syncAccount(session);
  });
</script>

</body>
</html>
